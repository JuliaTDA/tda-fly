---
title: "Diaptera wings classification using Topological Data Analysis"
author:
  - name: G. Vituri
    orcid: 0000-0002-0760-5497
    corresponding: true
    email: steve@curvenote.com
    roles:
      - Investigation
      - Project administration
      - Software
      - Visualization
    affiliations:
      - etc
  - name: Sergio Ura
  - name: Northon
keywords:
  - Topological Data Analysis
  - Persistent homology
abstract: |
  In September 2021, a significant jump in seismic activity on the island of La Palma (Canary Islands, Spain) signaled the start of a volcanic crisis that still continues at the time of writing. Earthquake data is continually collected and published by the Instituto Geográphico Nacional (IGN). ...
plain-language-summary: |
  Earthquake data for the island of La Palma from the September 2021 eruption is found ...
key-points:
  - A web scraping script was developed to pull data from the Instituto Geogràphico Nacional into a machine-readable form for analysis
  - Earthquake events on La Palma are consistent with the presence of both mantle and crustal reservoirs.
date: last-modified
bibliography: references.bib
citation:
  container-title: Earth and Space Science
number-sections: true
---

```{julia}
using TDAfly, TDAfly.Preprocessing, TDAfly.TDA
using Images
using Plots: heatmap, plot, @layout, scatter
using PersistenceDiagrams
```

## Introduction

Falar sobre o dataset, TDA, etc.

## Methods

We read all wings into images

```{julia}
paths = readdir("images/processed", join = true)
species = basename.(paths)
wings = load_wing.(paths)
Xs = map(image_to_r2, wings)

mosaicview(wings, ncol = 4, fillvalue=1)
```

and then select 750 random points from each image

```{julia}
samples = random_sample.(Xs, 750);
```

to calculate its persistence diagrams using the Vietoris-Rips filtration etc.

```{julia}
# get only the 1-dimensional PD
rips = rips_pd.(samples, cutoff = 5, threshold = 200) .|> last;
```

We create the 1-dimensional persistence image for each persistence diagram using 10x10 matrices

```{julia}
PI = PersistenceImage(rips, size = (10, 10))

images = PI.(rips)

function plot_wing_with_pd(rip, image, sample, title)
  l = @layout [a b; c]

  plot(
      plot_pd(rip, persistence = true)
      ,heatmap(image)
      ,scatter(first.(sample), last.(sample))
      ,layout = l
      ,plot_title = title
  )
end;
```

### Examples

Below are some examples of 1-dimensional barcodes, its persistence image and the original wing that generated it. Note: we are plotting the barcode using the birth and persistence.

```{julia}
i = 1
plot_wing_with_pd(rips[i], images[i], samples[i], species[i])
```


```{julia}
i = 5
plot_wing_with_pd(rips[i], images[i], samples[i], species[i])
```


```{julia}
i = 8
plot_wing_with_pd(rips[i], images[i], samples[i], species[i])
```

```{julia}
i = 10
plot_wing_with_pd(rips[i], images[i], samples[i], species[i])
```

```{julia}
i = 15
plot_wing_with_pd(rips[i], images[i], samples[i], species[i])
```

```{julia}
i = 16
plot_wing_with_pd(rips[i], images[i], samples[i], species[i])
```